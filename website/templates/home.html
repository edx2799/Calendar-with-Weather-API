{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}

<!-- Title for the calendar section -->
<h1 align="center">Calendar</h1>
<!-- Div where the FullCalendar will render -->
<div id="calendar"></div>

<!-- Title and form for the weather forecast input -->
<h2 align="center">Weekly Weather Forecast</h2>
<form id="locationForm" align="center">
    <label for="city">Enter City:</label>
    <input type="text" id="city" placeholder="e.g., Los Angeles, CA" required>
    <button type="button" onclick="getCoordinates()">Get Weather</button>
</form>
<!-- Div where the weather forecast will be displayed -->
<div id="weatherDisplay" align="center"></div>

<!-- FullCalendar library for rendering the calendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let calendarEl = document.getElementById('calendar');

        let calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            editable: true,
            selectable: true,
            events: '/events',

            dateClick: function(info) {
                const title = prompt('Enter Event Title:');
                const time = prompt('Enter Event Time (HH:MM format):');
                const color = prompt('Enter Event Color:\nOptions:\n- red\n- blue\n- green\n- orange\n- purple\n- pink\n- yellow\n- brown\n- gray\n- black\n');

                if (title && time) {
                    const eventData = {
                        title: title,
                        start: `${info.dateStr}T${time}:00`,
                        color: color
                    };
                    calendar.addEvent(eventData);
                    saveEvent(eventData);
                }
            },

            eventClick: function(info) {
                if (confirm('Would you like to delete this event?')) {
                    deleteEvent(info.event.id);
                    info.event.remove();
                }
            }
        });

        calendar.render();

        function saveEvent(eventData) {
            fetch('/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    eventData.id = data.id; // Assign ID to event after save
                }
            })
            .catch(error => console.error("Error saving event:", error));
        }

        function deleteEvent(eventId) {
            fetch(`/delete-event/${eventId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error("Failed to delete event");
                }
            })
            .catch(error => console.error("Error deleting event:", error));
        }
    });

    async function getCoordinates() {
        const city = document.getElementById('city').value;
        const geocodeUrl = `https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(city)}&format=json&limit=1`;

        try {
            const response = await fetch(geocodeUrl);
            const data = await response.json();
            if (data && data.length > 0) {
                const lat = data[0].lat;
                const lon = data[0].lon;
                getWeather(lat, lon);
            } else {
                document.getElementById('weatherDisplay').innerText = 'Location not found';
            }
        } catch (error) {
            document.getElementById('weatherDisplay').innerText = 'Error fetching location';
        }
    }

    async function getWeather(lat, lon) {
        const weatherUrl = `https://api.weather.gov/points/${lat},${lon}`;

        try {
            const response = await fetch(weatherUrl);
            const data = await response.json();
            const forecastUrl = data.properties.forecast;

            const forecastResponse = await fetch(forecastUrl);
            const forecastData = await forecastResponse.json();

            const periods = forecastData.properties.periods.slice(0, 14);
            let weatherHtml = '<h3>7-Day Forecast:</h3><ul>';
            periods.forEach(day => {
                weatherHtml += `<li><strong>${day.name}:</strong> ${day.temperature}Â°${day.temperatureUnit}, ${day.shortForecast}</li>`;
            });
            weatherHtml += '</ul>';

            document.getElementById('weatherDisplay').innerHTML = weatherHtml;
        } catch (error) {
            document.getElementById('weatherDisplay').innerText = 'Error fetching weather data';
        }
    }
</script>

{% endblock %}
